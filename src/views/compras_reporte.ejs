<%- include('partials/_header') %>
<div class="container mt-4">
  <h2>Reporte de compras</h2>
  <% compras.forEach(function(compra, idx){ %>
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><b>Compra #<%= compra.dataValues.id %></b></span>
        <button class="btn btn-info btn-sm" data-bs-toggle="collapse" data-bs-target="#detalles<%= idx %>">
          Detalles
        </button>
      </div>
      <div class="card-body">
        <p>Fecha: <%= compra.dataValues.fecha ? compra.dataValues.fecha.toISOString().slice(0,10) : '-' %></p>
        <p>Proveedor: <%= compra.dataValues.proveedor ? compra.dataValues.proveedor.dataValues.nombre : compra.dataValues.proveedor_id %></p>
        <div class="collapse" id="detalles<%= idx %>">
          <table class="table table-bordered mt-3">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio unitario</th>
                <th>Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <% (compra.dataValues.detalles || []).forEach(function(d){ %>
                <tr>
                  <td>
                    <%= d.producto 
                        ? d.producto.dataValues.nombre 
                        : d.producto_id %>
                  </td>
                  <td><%= d.cantidad %></td>
                  <td>S/<%= d.precio_unit %></td>
                  <td>S/<%= (d.cantidad * d.precio_unit).toFixed(2) %></td>
                </tr>
              <% }); %>
              <% if (!compra.dataValues.detalles || compra.dataValues.detalles.length === 0) { %>
                <tr>
                  <td colspan="4" class="text-center">Sin detalles registrados.</td>
                </tr>
              <% } %>
            </tbody>
          </table>
          <h5>Total: S/ <%= (compra.dataValues.detalles || []).reduce((acc, d) => acc + (d.cantidad * d.precio_unit), 0).toFixed(2) %></h5>
        </div>
      </div>
    </div>
  <% }); %>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<%- include('partials/_footer') %>
